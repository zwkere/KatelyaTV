name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      discussions: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # ä¿®æ”¹è¿™é‡Œï¼šæ”¹ä¸º pnpm æˆ–è€…ç§»é™¤ cache é…ç½®
          # cache: 'npm'  # åˆ é™¤è¿™è¡Œï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯ pnpm
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          # æ·»åŠ  pnpm ç¼“å­˜é…ç½®
          run_install: false
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build project
        run: pnpm run build
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            .next/**/*
            public/**/*
            package.json
            README.md
            CHANGELOG.md
            LICENSE
            config.json
            next.config.js
            tailwind.config.ts
            tsconfig.json
            Dockerfile
            vercel.json
          generate_release_notes: true
          draft: false
          prerelease: false
          title: 'ğŸ‰ Release ${{ github.ref_name }}'
          body: |
            ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
            
            **ç‰ˆæœ¬å·**: ${{ github.ref_name }}
            **å‘å¸ƒæ—¥æœŸ**: ${{ github.event.head_commit.timestamp }}
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            
            #### Docker éƒ¨ç½²ï¼ˆæ¨èï¼‰
            ```bash
            docker pull ghcr.io/senshinya/moontv:${{ github.ref_name }}
            docker run -d --name moontv -p 3000:3000 --env PASSWORD=your_password ghcr.io/senshinya/moontv:${{ github.ref_name }}
            ```
            
            #### Vercel éƒ¨ç½²
            - Fork æœ¬ä»“åº“
            - åœ¨ Vercel ä¸­å¯¼å…¥é¡¹ç›®
            - è®¾ç½®ç¯å¢ƒå˜é‡ PASSWORD
            - è‡ªåŠ¨éƒ¨ç½²å®Œæˆ
            
            #### Cloudflare Pages éƒ¨ç½²
            - Fork æœ¬ä»“åº“
            - åœ¨ Cloudflare Pages ä¸­å¯¼å…¥é¡¹ç›®
            - è®¾ç½®æ„å»ºå‘½ä»¤ï¼š`pnpm run pages:build`
            - é…ç½®ç¯å¢ƒå˜é‡
            
            ### ğŸ“‹ ç¯å¢ƒå˜é‡
            
            | å˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
            |------|------|--------|
            | PASSWORD | è®¿é—®å¯†ç  | å¿…å¡« |
            | NEXT_PUBLIC_STORAGE_TYPE | å­˜å‚¨ç±»å‹ | localstorage |
            | USERNAME | ç®¡ç†å‘˜è´¦å· | ç©º |
            
            æ›´å¤šç¯å¢ƒå˜é‡è¯·æŸ¥çœ‹ [README.md](README.md)
            
            ### ğŸ”— ç›¸å…³èµ„æº
            
            - [é¡¹ç›®æ–‡æ¡£](https://github.com/senshinya/moontv#readme)
            - [é—®é¢˜åé¦ˆ](https://github.com/senshinya/moontv/issues)
            - [åŠŸèƒ½è®¨è®º](https://github.com/senshinya/moontv/discussions)
            - [è´¡çŒ®æŒ‡å—](https://github.com/senshinya/moontv/blob/main/CONTRIBUTING.md)
            
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            
            æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†å²ã€‚
            
            ---
            
            **æ³¨æ„**: æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œä¸ªäººä½¿ç”¨ï¼Œè¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ã€‚
      
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/senshinya/moontv:${{ github.ref_name }}
            ghcr.io/senshinya/moontv:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
      
      - name: Update Release with Docker Info
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
            
            **ç‰ˆæœ¬å·**: ${{ github.ref_name }}
            **å‘å¸ƒæ—¥æœŸ**: ${{ github.event.head_commit.timestamp }}
            
            ### ğŸ³ Docker é•œåƒ
            
            Docker é•œåƒå·²è‡ªåŠ¨æ„å»ºå¹¶æ¨é€åˆ° GitHub Container Registryï¼š
            
            ```bash
            # æ‹‰å–æŒ‡å®šç‰ˆæœ¬
            docker pull ghcr.io/senshinya/moontv:${{ github.ref_name }}
            
            # æ‹‰å–æœ€æ–°ç‰ˆæœ¬
            docker pull ghcr.io/senshinya/moontv:latest
            
            # è¿è¡Œå®¹å™¨
            docker run -d --name moontv -p 3000:3000 --env PASSWORD=your_password ghcr.io/senshinya/moontv:${{ github.ref_name }}
            ```
            
            ### ğŸš€ å…¶ä»–éƒ¨ç½²æ–¹å¼
            
            #### Vercel éƒ¨ç½²
            - Fork æœ¬ä»“åº“
            - åœ¨ Vercel ä¸­å¯¼å…¥é¡¹ç›®
            - è®¾ç½®ç¯å¢ƒå˜é‡ PASSWORD
            - è‡ªåŠ¨éƒ¨ç½²å®Œæˆ
            
            #### Cloudflare Pages éƒ¨ç½²
            - Fork æœ¬ä»“åº“
            - åœ¨ Cloudflare Pages ä¸­å¯¼å…¥é¡¹ç›®
            - è®¾ç½®æ„å»ºå‘½ä»¤ï¼š`pnpm run pages:build`
            - é…ç½®ç¯å¢ƒå˜é‡
            
            ### ğŸ“‹ ç¯å¢ƒå˜é‡
            
            | å˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
            |------|------|--------|
            | PASSWORD | è®¿é—®å¯†ç  | å¿…å¡« |
            | NEXT_PUBLIC_STORAGE_TYPE | å­˜å‚¨ç±»å‹ | localstorage |
            | USERNAME | ç®¡ç†å‘˜è´¦å· | ç©º |
            
            æ›´å¤šç¯å¢ƒå˜é‡è¯·æŸ¥çœ‹ [README.md](README.md)
            
            ### ğŸ”— ç›¸å…³èµ„æº
            
            - [é¡¹ç›®æ–‡æ¡£](https://github.com/senshinya/moontv#readme)
            - [é—®é¢˜åé¦ˆ](https://github.com/senshinya/moontv/issues)
            - [åŠŸèƒ½è®¨è®º](https://github.com/senshinya/moontv/discussions)
            - [è´¡çŒ®æŒ‡å—](https://github.com/senshinya/moontv/blob/main/CONTRIBUTING.md)
            
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            
            æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†å²ã€‚
            
            ---
            
            **æ³¨æ„**: æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œä¸ªäººä½¿ç”¨ï¼Œè¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ã€‚
          update_existing_release: true
      
      - name: Create Discussion
        uses: actions/github-script@v7
        with:
          script: |
            const { data: discussions } = await github.rest.discussions.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ‰ ${context.ref_name} ç‰ˆæœ¬å‘å¸ƒè®¨è®º`,
              body: `## ğŸ‰ ${context.ref_name} ç‰ˆæœ¬å‘å¸ƒæˆåŠŸï¼
              
              æ–°ç‰ˆæœ¬å·²æˆåŠŸå‘å¸ƒï¼ŒåŒ…å«ä»¥ä¸‹æ›´æ–°ï¼š
              
              ### ğŸš€ ä¸»è¦ç‰¹æ€§
              - è§‚çœ‹å†å²è®°å½•åŠŸèƒ½
              - å¤šæºèšåˆæœç´¢
              - PWA æ”¯æŒ
              - æ·±è‰²æ¨¡å¼
              - å¤šç”¨æˆ·ç³»ç»Ÿ
              
              ### ğŸ³ Docker éƒ¨ç½²
              \`\`\`bash
              docker pull ghcr.io/senshinya/moontv:${context.ref_name}
              docker run -d --name moontv -p 3000:3000 --env PASSWORD=your_password ghcr.io/senshinya/moontv:${context.ref_name}
              \`\`\`
              
              ### ğŸ“‹ ç¯å¢ƒå˜é‡
              | å˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
              |------|------|--------|
              | PASSWORD | è®¿é—®å¯†ç  | å¿…å¡« |
              | NEXT_PUBLIC_STORAGE_TYPE | å­˜å‚¨ç±»å‹ | localstorage |
              | USERNAME | ç®¡ç†å‘˜è´¦å· | ç©º |
              
              ### ğŸ”— ç›¸å…³é“¾æ¥
              - [Release é¡µé¢](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${context.ref_name})
              - [é¡¹ç›®æ–‡æ¡£](https://github.com/${context.repo.owner}/${context.repo.repo}#readme)
              - [é—®é¢˜åé¦ˆ](https://github.com/${context.repo.owner}/${context.repo.repo}/issues)
              
              ---
              
              æ¬¢è¿åœ¨æ­¤è®¨è®ºæ–°ç‰ˆæœ¬çš„ä½¿ç”¨ä½“éªŒã€é—®é¢˜åé¦ˆå’ŒåŠŸèƒ½å»ºè®®ï¼
              
              **æ³¨æ„**: æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œä¸ªäººä½¿ç”¨ï¼Œè¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ã€‚`,
              category: 'ANNOUNCEMENT'
            });
            
            console.log(`Discussion created: ${discussions.html_url}`);
      
      - name: Comment on Issues
        uses: actions/github-script@v7
        with:
          script: |
            // æŸ¥æ‰¾ä¸å½“å‰ç‰ˆæœ¬ç›¸å…³çš„ issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['enhancement', 'bug', 'feature']
            });
            
            // åœ¨ç›¸å…³ issue ä¸‹æ·»åŠ è¯„è®º
            for (const issue of issues) {
              if (issue.title.toLowerCase().includes('release') || 
                  issue.title.toLowerCase().includes('version') ||
                  issue.body?.toLowerCase().includes('release') ||
                  issue.body?.toLowerCase().includes('version')) {
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ğŸ‰ å¥½æ¶ˆæ¯ï¼${context.ref_name} ç‰ˆæœ¬å·²ç»å‘å¸ƒï¼Œå¯èƒ½è§£å†³äº†æ‚¨æåˆ°çš„é—®é¢˜ã€‚
                  
                  è¯·æŸ¥çœ‹ [Release é¡µé¢](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${context.ref_name}) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
                  
                  å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œæˆ‘ä»¬ä¼šç»§ç»­å…³æ³¨ã€‚`
                });
                
                console.log(`Commented on issue #${issue.number}`);
              }
            }
      
      - name: Notify Success
        run: |
          echo "ğŸ‰ Release ${{ github.ref_name }} å‘å¸ƒæˆåŠŸï¼"
          echo "ğŸ“¦ Docker é•œåƒ: ghcr.io/senshinya/moontv:${{ github.ref_name }}"
          echo "ğŸ”— Release é¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo "ğŸ“ æ›´æ–°æ—¥å¿—: https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md"
