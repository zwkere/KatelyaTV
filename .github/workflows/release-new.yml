name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      discussions: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm run build

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            package.json
            pnpm-lock.yaml
            next.config.js
            tailwind.config.ts
            tsconfig.json
            Dockerfile
            vercel.json
          generate_release_notes: true
          draft: false
          prerelease: false
          tag_name: ${{ github.ref_name }}
          name: 'ğŸ‰ Release ${{ github.ref_name }}'
          body: |
            ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ

            **ç‰ˆæœ¬å·**: ${{ github.ref_name }}
            **å‘å¸ƒæ—¥æœŸ**: ${{ github.event.head_commit.timestamp }}

            ### ğŸš€ å¿«é€Ÿå¼€å§‹

            #### Docker éƒ¨ç½²ï¼ˆæ¨èï¼‰
            ```bash
            docker pull ghcr.io/katelya77/katelyatv:${{ github.ref_name }}
            docker run -d --name katelyatv -p 3000:3000 --env PASSWORD=your_password ghcr.io/katelya77/katelyatv:${{ github.ref_name }}
            ```

            #### Cloudflare Pages éƒ¨ç½²
            - Fork æœ¬ä»“åº“
            - åœ¨ Cloudflare Pages ä¸­å¯¼å…¥é¡¹ç›®
            - æ„å»ºå‘½ä»¤ï¼š`pnpm pages:build`
            - è¾“å‡ºç›®å½•ï¼š`.vercel/output/static`

            #### Vercel éƒ¨ç½²
            - Fork æœ¬ä»“åº“
            - åœ¨ Vercel ä¸­å¯¼å…¥é¡¹ç›®
            - æ„å»ºå‘½ä»¤ï¼š`pnpm run build`

            ### ğŸ“‹ ç¯å¢ƒå˜é‡

            | å˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
            |------|------|--------|
            | PASSWORD | è®¿é—®å¯†ç  | å¿…å¡« |
            | NEXT_PUBLIC_STORAGE_TYPE | å­˜å‚¨ç±»å‹ | localstorage |
            | USERNAME | ç®¡ç†å‘˜è´¦å· | ç©º |

            æ›´å¤šç¯å¢ƒå˜é‡è¯·æŸ¥çœ‹ [README.md](README.md)

            ### ğŸ”— ç›¸å…³èµ„æº

            - [é¡¹ç›®æ–‡æ¡£](https://github.com/katelya77/KatelyaTV#readme)
            - [é—®é¢˜åé¦ˆ](https://github.com/katelya77/KatelyaTV/issues)
            - [åŠŸèƒ½è®¨è®º](https://github.com/katelya77/KatelyaTV/discussions)
            - [è´¡çŒ®æŒ‡å—](https://github.com/katelya77/KatelyaTV/blob/main/CONTRIBUTING.md)

            ### ğŸ“ æ›´æ–°æ—¥å¿—

            æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†çš„æ›´æ–°å†å²ã€‚

            ---

            **æ³¨æ„**: æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œä¸ªäººä½¿ç”¨ï¼Œè¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ã€‚

  docker:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/katelya77/katelyatv:${{ github.ref_name }}
            ghcr.io/katelya77/katelyatv:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
