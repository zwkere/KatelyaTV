# Kvrocks å­˜å‚¨æ–¹æ¡ˆ

## ğŸŒŸ ä»€ä¹ˆæ˜¯ Kvrocksï¼Ÿ

Kvrocks æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é”®å€¼æ•°æ®åº“ï¼Œå…¼å®¹ Redis åè®®ï¼ŒåŸºäº RocksDB å­˜å‚¨å¼•æ“ã€‚å®ƒæä¾›äº†æ¯” Redis æ›´é«˜çš„æ•°æ®å¯é æ€§å’Œæ›´å¥½çš„æˆæœ¬æ•ˆç›Šã€‚

## ğŸ†š ä¸ Redis å¯¹æ¯”

| ç‰¹æ€§           | Redis                | Kvrocks                  |
| -------------- | -------------------- | ------------------------ |
| **æ•°æ®æŒä¹…æ€§** | å†…å­˜ + AOF/RDB å¤‡ä»½  | **ç£ç›˜åŸç”Ÿå­˜å‚¨**         |
| **æ•°æ®ä¸¢å¤±**   | å¯èƒ½ä¸¢å¤±æœ€åå‡ ç§’æ•°æ® | **å‡ ä¹é›¶æ•°æ®ä¸¢å¤±é£é™©**   |
| **å†…å­˜ä½¿ç”¨**   | å…¨éƒ¨æ•°æ®åœ¨å†…å­˜       | **ä»…ç¼“å­˜çƒ­æ•°æ®**         |
| **å­˜å‚¨æˆæœ¬**   | å—å†…å­˜é™åˆ¶ï¼Œæˆæœ¬è¾ƒé«˜ | **ç£ç›˜å­˜å‚¨ï¼Œæˆæœ¬ä½**     |
| **æ‰©å±•æ€§**     | å—å†…å­˜é™åˆ¶           | **å¯å¤„ç†æ›´å¤§æ•°æ®é›†**     |
| **åè®®å…¼å®¹**   | Redis åè®®           | **å®Œå…¨å…¼å®¹ Redis åè®®**  |
| **æ€§èƒ½**       | æé«˜ï¼ˆçº¯å†…å­˜ï¼‰       | **é«˜æ€§èƒ½ï¼ˆæ¥è¿‘ Redisï¼‰** |

## ğŸ¯ é€‚ç”¨åœºæ™¯

### âœ… æ¨èä½¿ç”¨ Kvrocks

- ğŸ¢ **ç”Ÿäº§ç¯å¢ƒ**ï¼šéœ€è¦é«˜å¯é æ€§çš„ç”Ÿäº§éƒ¨ç½²
- ğŸ’¾ **æ•°æ®é‡è¦**ï¼šç”¨æˆ·æ’­æ”¾è®°å½•ã€æ”¶è—ç­‰é‡è¦æ•°æ®ä¸èƒ½ä¸¢å¤±
- ğŸ’° **æˆæœ¬æ•æ„Ÿ**ï¼šå¸Œæœ›é™ä½å†…å­˜æˆæœ¬ï¼Œä½¿ç”¨ä¾¿å®œçš„ç£ç›˜å­˜å‚¨
- ğŸ“ˆ **é•¿æœŸä½¿ç”¨**ï¼šè®¡åˆ’é•¿æœŸè¿è¡Œï¼Œæ•°æ®é‡å¯èƒ½æŒç»­å¢é•¿

### âŒ ä¸å»ºè®®ä½¿ç”¨ Kvrocks

- ğŸƒ **æé€Ÿæ€§èƒ½**ï¼šéœ€è¦å¾®ç§’çº§å“åº”æ—¶é—´çš„é«˜é¢‘äº¤æ˜“åœºæ™¯
- ğŸ”¥ **çº¯ç¼“å­˜**ï¼šæ•°æ®å¯ä»¥éšæ—¶ä¸¢å¤±çš„çº¯ç¼“å­˜åœºæ™¯
- ğŸ“± **è½»é‡éƒ¨ç½²**ï¼šèµ„æºéå¸¸æœ‰é™çš„è®¾å¤‡ï¼ˆå¦‚ä½é…ç½®æ ‘è“æ´¾ï¼‰

## ğŸš€ éƒ¨ç½²ä¼˜åŠ¿

### 1. æ•°æ®å®‰å…¨

- **é›¶é…ç½®æŒä¹…åŒ–**ï¼šæ— éœ€é…ç½® AOF æˆ– RDBï¼Œæ•°æ®è‡ªåŠ¨æŒä¹…åŒ–åˆ°ç£ç›˜
- **æ–­ç”µä¿æŠ¤**ï¼šå³ä½¿çªç„¶æ–­ç”µï¼Œå·²æäº¤çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±
- **åŸå­æ“ä½œ**ï¼šåŸºäº RocksDB çš„äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§

### 2. èµ„æºä¼˜åŒ–

- **å†…å­˜å‹å¥½**ï¼šåªéœ€è¦ Redis 1/10 çš„å†…å­˜
- **ç£ç›˜é«˜æ•ˆ**ï¼šæ™ºèƒ½å‹ç¼©ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
- **CPU å‹å¥½**ï¼šåå°å‹ç¼©å’Œåˆå¹¶ï¼Œä¸å½±å“å‰å°æ€§èƒ½

### 3. è¿ç»´ç®€å•

- **å…ç»´æŠ¤**ï¼šæ— éœ€å®šæœŸå¤‡ä»½ï¼Œæ•°æ®è‡ªåŠ¨æŒä¹…åŒ–

## ğŸ”§ å¿«é€Ÿéƒ¨ç½²

### æ— å¯†ç éƒ¨ç½²ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```bash
# 1. è®¾ç½®ç¯å¢ƒå˜é‡
cp .env.kvrocks.example .env
# ç¼–è¾‘ .envï¼Œä¸è®¾ç½® KVROCKS_PASSWORD

# 2. å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.kvrocks.yml up -d
```

### å¯†ç è®¤è¯éƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# 1. è®¾ç½®ç¯å¢ƒå˜é‡
cp .env.kvrocks.example .env
# ç¼–è¾‘ .envï¼Œè®¾ç½® KVROCKS_PASSWORD=your_secure_password

# 2. å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.kvrocks.auth.yml up -d
```

ğŸ“– **è¯¦ç»†éƒ¨ç½²æŒ‡å—**ï¼šè¯·å‚è€ƒ [KVROCKS_DEPLOYMENT.md](./KVROCKS_DEPLOYMENT.md)

- **ç›‘æ§ç®€å•**ï¼šæä¾›æ ‡å‡† Redis ç›‘æ§æ¥å£
- **è¿ç§»å®¹æ˜“**ï¼šå®Œå…¨å…¼å®¹ Redis å®¢æˆ·ç«¯å’Œå·¥å…·

## âš¡ æ€§èƒ½è¡¨ç°

åœ¨ KatelyaTV çš„å®é™…ä½¿ç”¨åœºæ™¯ä¸­ï¼š

- **è¯»å–æ€§èƒ½**ï¼šæ¥è¿‘ Redisï¼Œæ¯«ç§’çº§å“åº”
- **å†™å…¥æ€§èƒ½**ï¼šç•¥ä½äº Redisï¼Œä½†ä»ç„¶å¾ˆå¿«
- **å†…å­˜ä½¿ç”¨**ï¼šä»…ä¸º Redis çš„ 10-20%
- **ç£ç›˜ç©ºé—´**ï¼šæ•°æ®å‹ç¼©åå ç”¨æ›´å°‘ç©ºé—´

## ğŸ”§ é…ç½®å»ºè®®

### ç¡¬ä»¶è¦æ±‚

- **CPU**ï¼š2 æ ¸å¿ƒå³å¯æ»¡è¶³å¤§éƒ¨åˆ†éœ€æ±‚
- **å†…å­˜**ï¼š512MB - 1GB å³å¯ï¼ˆRedis éœ€è¦ 4-8GBï¼‰
- **ç£ç›˜**ï¼šå»ºè®®ä½¿ç”¨ SSDï¼Œè‡³å°‘ 10GB ç©ºé—´
- **ç½‘ç»œ**ï¼šæ ‡å‡†ç½‘ç»œå³å¯

### ç³»ç»Ÿé…ç½®

```bash
# æ¨èçš„ç³»ç»Ÿå‚æ•°
echo 'vm.swappiness = 1' >> /etc/sysctl.conf
echo 'vm.overcommit_memory = 1' >> /etc/sysctl.conf
sysctl -p
```

## ğŸ“Š å®é™…æ¡ˆä¾‹

### ç”¨æˆ·åé¦ˆ

> "ä½¿ç”¨ Kvrocks åï¼Œå†ä¹Ÿä¸ç”¨æ‹…å¿ƒé‡å¯æœåŠ¡å™¨ä¸¢å¤±è§‚çœ‹è®°å½•äº†ï¼" - æŸç”¨æˆ·

> "å†…å­˜å ç”¨é™ä½äº† 80%ï¼ŒæœåŠ¡å™¨æˆæœ¬å¤§å¹…ä¸‹é™ã€‚" - æŸç®¡ç†å‘˜

### æ•°æ®å¯¹æ¯”

- **Redis æ–¹æ¡ˆ**ï¼š8GB å†…å­˜ï¼Œæ¯æœˆ $40
- **Kvrocks æ–¹æ¡ˆ**ï¼š1GB å†…å­˜ + 20GB SSDï¼Œæ¯æœˆ $15
- **æˆæœ¬èŠ‚çœ**ï¼šçº¦ 60% çš„åŸºç¡€è®¾æ–½æˆæœ¬

## ğŸ› ï¸ è¿ç§»æŒ‡å—

### ä» Redis è¿ç§»åˆ° Kvrocks

1. **åœæ­¢åº”ç”¨**ï¼š`docker compose down`
2. **å¤‡ä»½æ•°æ®**ï¼š`docker compose exec redis redis-cli BGSAVE`
3. **å¯¼å‡ºæ•°æ®**ï¼š`docker compose exec redis redis-cli --rdb /data/dump.rdb`
4. **å¯åŠ¨ Kvrocks**ï¼š`docker compose -f docker-compose.kvrocks.yml up -d`
5. **å¯¼å…¥æ•°æ®**ï¼šä½¿ç”¨ Redis å·¥å…·å¯¼å…¥å¤‡ä»½æ•°æ®
6. **éªŒè¯æ•°æ®**ï¼šæ£€æŸ¥æ•°æ®å®Œæ•´æ€§
7. **åˆ‡æ¢åº”ç”¨**ï¼šä¿®æ”¹ç¯å¢ƒå˜é‡ï¼Œé‡å¯åº”ç”¨

### å›æ»šæ–¹æ¡ˆ

å¦‚æœéœ€è¦å›æ»šåˆ° Redisï¼š

1. ä» Kvrocks å¯¼å‡ºæ•°æ®
2. å¯åŠ¨ Redis æœåŠ¡
3. å¯¼å…¥æ•°æ®åˆ° Redis
4. ä¿®æ”¹ç¯å¢ƒå˜é‡
5. é‡å¯åº”ç”¨

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ç›‘æ§å»ºè®®

```bash
# ç›‘æ§ Kvrocks çŠ¶æ€
docker compose exec kvrocks redis-cli info stats
docker compose exec kvrocks redis-cli info memory
docker compose exec kvrocks redis-cli info persistence
```

### 2. å¤‡ä»½ç­–ç•¥

```bash
# æ¯æ—¥è‡ªåŠ¨å¤‡ä»½
0 2 * * * docker run --rm -v kvrocks_data:/data -v /backup:/backup alpine tar czf /backup/kvrocks-$(date +%Y%m%d).tar.gz /data
```

### 3. æ€§èƒ½è°ƒä¼˜

- å®šæœŸæ£€æŸ¥ç£ç›˜ä½¿ç”¨ç‡
- ç›‘æ§å‹ç¼©ç‡å’Œå»¶è¿Ÿ
- æ ¹æ®è´Ÿè½½è°ƒæ•´ç¼“å­˜ç­–ç•¥

---

**æ€»ç»“**ï¼šKvrocks æ˜¯ Redis çš„å®Œç¾æ›¿ä»£æ–¹æ¡ˆï¼Œç‰¹åˆ«é€‚åˆ KatelyaTV è¿™ç§éœ€è¦é«˜å¯é æ€§æ•°æ®å­˜å‚¨çš„åº”ç”¨åœºæ™¯ã€‚å®ƒåœ¨ä¿æŒ Redis å…¼å®¹æ€§çš„åŒæ—¶ï¼Œæä¾›äº†æ›´å¥½çš„æ•°æ®å®‰å…¨æ€§å’Œæ›´ä½çš„è¿è¥æˆæœ¬ã€‚
